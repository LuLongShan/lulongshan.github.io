<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><title>Rust Smart Pointer - Joe</title><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1,minimum-scale=1,user-scalable=no,minimal-ui"><meta name=renderer content="webkit"><meta http-equiv=cache-control content="no-transform"><meta http-equiv=cache-control content="no-siteapp"><meta name=apple-mobile-web-app-capable content="yes"><meta name=apple-mobile-web-app-status-bar-style content="black"><meta name=format-detection content="telephone=no,email=no,adress=no"><meta name=theme-color content="#000000"><meta http-equiv=window-target content="_top"><meta name=description content="Rust Smart Pointer (智能指针) 普通指针（Reference）: &amp;amp; 使用这个定义的，只是指向了对应的内存地址，并没有其他的功能； 智能指针（Smart Poin"><meta name=generator content="Hugo 0.79.0 with theme pure"><title>Rust Smart Pointer - Joe</title><link rel=stylesheet href=https://holicc.github.io/css/style.min.7dc20efbc53647d41aa9ddea0c48e59300223d084e66ea0cbe7c30bd88903acc.css><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#da532c"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://cdn.staticfile.org/highlight.js/9.15.10/styles/github.min.css async><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.4.2/tocbot.css async><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.css integrity=sha384-bsHo4/LA+lkZv61JspMDQB9QP1TtO4IgOf2yYS+J6VdAYLVyx1c3XKcsHh0Vy8Ws crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.js integrity=sha384-4z8mjH4yIpuK9dIQGR1JwbrfYsStrNK6MP+2Enhue4eyo0XlBDXOIPc8b6ZU0ajz crossorigin=anonymous></script><meta property="og:title" content="Rust Smart Pointer"><meta property="og:description" content="Rust Smart Pointer (智能指针) 普通指针（Reference）: & 使用这个定义的，只是指向了对应的内存地址，并没有其他的功能； 智能指针（Smart Poin"><meta property="og:type" content="article"><meta property="og:url" content="https://holicc.github.io/2020/08/rust-smart-pointer/"><meta property="article:published_time" content="2020-08-04T00:00:00+00:00"><meta property="article:modified_time" content="2020-08-04T00:00:00+00:00"><meta itemprop=name content="Rust Smart Pointer"><meta itemprop=description content="Rust Smart Pointer (智能指针) 普通指针（Reference）: & 使用这个定义的，只是指向了对应的内存地址，并没有其他的功能； 智能指针（Smart Poin"><meta itemprop=datePublished content="2020-08-04T00:00:00+00:00"><meta itemprop=dateModified content="2020-08-04T00:00:00+00:00"><meta itemprop=wordCount content="2545"><meta itemprop=keywords content="programing,rust,"><meta name=twitter:card content="summary"><meta name=twitter:title content="Rust Smart Pointer"><meta name=twitter:description content="Rust Smart Pointer (智能指针) 普通指针（Reference）: & 使用这个定义的，只是指向了对应的内存地址，并没有其他的功能； 智能指针（Smart Poin"><!--[if lte IE 9]><script src=https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js></script><![endif]--><!--[if lt IE 9]><script src=https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js></script><script src=https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js></script><![endif]--></head></head><body class="main-center theme-white" itemscope itemtype=http://schema.org/WebPage><header class=header itemscope itemtype=http://schema.org/WPHeader><div class=slimContent><div class=navbar-header><div class="profile-block text-center"><a id=avatar href=https://github.com/LuLongShan target=_blank><img class="img-circle img-rotate" src=https://holicc.github.io/avatar.png width=200 height=200></a><h2 id=name class="hidden-xs hidden-sm">Joe</h2><h3 id=title class="hidden-xs hidden-sm hidden-md">Hello World</h3><small id=location class="text-muted hidden-xs hidden-sm"><i class="icon icon-map-marker"></i>ChengDu, China</small></div><div class=search id=search-form-wrap><form class="search-form sidebar-form"><div class=input-group><input type=text class="search-form-input form-control" placeholder=Search>
<span class=input-group-btn><button type=submit class="search-form-submit btn btn-flat" onclick="return false;"><i class="icon icon-search"></i></button></span></div><div class=ins-search><div class=ins-search-mask></div><div class=ins-search-container><div class=ins-input-wrapper><input type=text class=ins-search-input placeholder="Type something..." x-webkit-speech>
<button type=button class="close ins-close ins-selectable" data-dismiss=modal aria-label=Close><span aria-hidden=true>×</span></button></div><div class=ins-section-wrapper><div class=ins-section-container></div></div></div></div></form></div><button class="navbar-toggle collapsed" type=button data-toggle=collapse data-target=#main-navbar aria-controls=main-navbar aria-expanded=false>
<span class=sr-only>Toggle navigation</span>
<span class=icon-bar></span><span class=icon-bar></span><span class=icon-bar></span></button></div><nav id=main-navbar class="collapse navbar-collapse" itemscope itemtype=http://schema.org/SiteNavigationElement role=navigation><ul class="nav navbar-nav main-nav"><li class="menu-item menu-item-home"><a href=/><i class="icon icon-home-fill"></i><span class=menu-title>Home</span></a></li><li class="menu-item menu-item-archives"><a href=/posts/><i class="icon icon-archives-fill"></i><span class=menu-title>Archives</span></a></li><li class="menu-item menu-item-categories"><a href=/categories/><i class="icon icon-folder"></i><span class=menu-title>Categories</span></a></li><li class="menu-item menu-item-tags"><a href=/tags/><i class="icon icon-tags"></i><span class=menu-title>Tags</span></a></li><li class="menu-item menu-item-about"><a href=/about/><i class="icon icon-cup-fill"></i><span class=menu-title>About</span></a></li></ul></nav></div></header><aside class=sidebar itemscope itemtype=http://schema.org/WPSideBar><div class=slimContent><div class=widget><h3 class=widget-title>Categories</h3><div class=widget-body><ul class=category-list><li class=category-list-item><a href=https://holicc.github.io/categories/database/ class=category-list-link>database</a><span class=category-list-count>1</span></li><li class=category-list-item><a href=https://holicc.github.io/categories/mysql/ class=category-list-link>mysql</a><span class=category-list-count>1</span></li><li class=category-list-item><a href=https://holicc.github.io/categories/programing/ class=category-list-link>programing</a><span class=category-list-count>21</span></li><li class=category-list-item><a href=https://holicc.github.io/categories/protocol/ class=category-list-link>protocol</a><span class=category-list-count>1</span></li><li class=category-list-item><a href=https://holicc.github.io/categories/rocketmq/ class=category-list-link>rocketmq</a><span class=category-list-count>1</span></li><li class=category-list-item><a href=https://holicc.github.io/categories/system-design/ class=category-list-link>system-design</a><span class=category-list-count>1</span></li><li class=category-list-item><a href=https://holicc.github.io/categories/windows/ class=category-list-link>windows</a><span class=category-list-count>1</span></li></ul></div></div><div class=widget><h3 class=widget-title>Tags</h3><div class=widget-body><ul class=tag-list><li class=tag-list-item><a href=https://holicc.github.io/tags/database/ class=tag-list-link>database</a><span class=tag-list-count>1</span></li><li class=tag-list-item><a href=https://holicc.github.io/tags/http/ class=tag-list-link>http</a><span class=tag-list-count>1</span></li><li class=tag-list-item><a href=https://holicc.github.io/tags/index/ class=tag-list-link>index</a><span class=tag-list-count>1</span></li><li class=tag-list-item><a href=https://holicc.github.io/tags/mysql/ class=tag-list-link>mysql</a><span class=tag-list-count>1</span></li><li class=tag-list-item><a href=https://holicc.github.io/tags/networking/ class=tag-list-link>networking</a><span class=tag-list-count>1</span></li><li class=tag-list-item><a href=https://holicc.github.io/tags/powershell/ class=tag-list-link>powershell</a><span class=tag-list-count>1</span></li><li class=tag-list-item><a href=https://holicc.github.io/tags/programing/ class=tag-list-link>programing</a><span class=tag-list-count>19</span></li><li class=tag-list-item><a href=https://holicc.github.io/tags/rocketmq/ class=tag-list-link>rocketmq</a><span class=tag-list-count>1</span></li><li class=tag-list-item><a href=https://holicc.github.io/tags/rust/ class=tag-list-link>rust</a><span class=tag-list-count>16</span></li><li class=tag-list-item><a href=https://holicc.github.io/tags/system-design/ class=tag-list-link>system-design</a><span class=tag-list-count>1</span></li><li class=tag-list-item><a href=https://holicc.github.io/tags/tcp/ class=tag-list-link>tcp</a><span class=tag-list-count>1</span></li><li class=tag-list-item><a href=https://holicc.github.io/tags/web/ class=tag-list-link>web</a><span class=tag-list-count>1</span></li></ul></div></div><div class=widget><h3 class=widget-title>Recent Posts</h3><div class=widget-body><ul class="recent-post-list list-unstyled no-thumbnail"><li><div class=item-inner><p class=item-title><a href=https://holicc.github.io/2020/12/go-timer/ class=title>Go Timer</a></p><p class=item-date><time datetime="2020-12-10 00:00:00 +0000 UTC" itemprop=datePublished>2020-12-10</time></p></div></li><li><div class=item-inner><p class=item-title><a href=https://holicc.github.io/2020/10/principles/ class=title>Common Principles</a></p><p class=item-date><time datetime="2020-10-10 00:00:00 +0000 UTC" itemprop=datePublished>2020-10-10</time></p></div></li><li><div class=item-inner><p class=item-title><a href=https://holicc.github.io/2020/09/http-range/ class=title>HTTP Range Download</a></p><p class=item-date><time datetime="2020-09-23 00:00:00 +0000 UTC" itemprop=datePublished>2020-09-23</time></p></div></li><li><div class=item-inner><p class=item-title><a href=https://holicc.github.io/2020/09/about-logout-method/ class=title>Logout GET or POST</a></p><p class=item-date><time datetime="2020-09-10 00:00:00 +0000 UTC" itemprop=datePublished>2020-09-10</time></p></div></li><li><div class=item-inner><p class=item-title><a href=https://holicc.github.io/2020/09/go-code-snippet/ class=title>Go Code Style</a></p><p class=item-date><time datetime="2020-09-01 00:00:00 +0000 UTC" itemprop=datePublished>2020-09-01</time></p></div></li></ul></div></div></div></aside><aside class="sidebar sidebar-toc collapse" id=collapseToc itemscope itemtype=http://schema.org/WPSideBar><div class=slimContent><h4 class=toc-title>Catalogue</h4><nav id=toc class="js-toc toc"></nav></div></aside><main class=main role=main><div class=content><article id=- class="article article-type-" itemscope itemtype=http://schema.org/BlogPosting><div class=article-header><h1 itemprop=name><a class=article-title href=/2020/08/rust-smart-pointer/>Rust Smart Pointer</a></h1><div class=article-meta><span class=article-date><i class="icon icon-calendar-check"></i>&nbsp;
<a href=https://holicc.github.io/2020/08/rust-smart-pointer/ class=article-date><time datetime="2020-08-04 00:00:00 +0000 UTC" itemprop=datePublished>2020-08-04</time></a></span>
<span class=article-category><i class="icon icon-folder"></i>&nbsp;
<a class=article-category-link href=/categories/programing/>programing</a></span>
<span class=article-tag><i class="icon icon-tags"></i>&nbsp;
<a class=article-tag-link href=/tags/programing/>programing</a>
<a class=article-tag-link href=/tags/rust/>rust</a></span>
<span class=post-comment><i class="icon icon-comment"></i>&nbsp;<a href=/2020/08/rust-smart-pointer/#comments class=article-comment-link>Comments</a></span>
<span class="post-wordcount hidden-xs" itemprop=wordCount>Word Count: 2545words</span>
<span class="post-readcount hidden-xs" itemprop=timeRequired>Read Count: 6minutes</span></div></div><div class="article-entry marked-body js-toc-content" itemprop=articleBody><h2 id=rust-smart-pointer-智能指针>Rust Smart Pointer (智能指针)</h2><p>普通指针（Reference）: <code>&</code> 使用这个定义的，只是指向了对应的内存地址，并没有其他的功能；</p><p>智能指针（Smart Pointer）就是能够拥有多个<em>owner</em>并且在没有<em>owner</em>时自动清理回收。（GC？！），并且提供了一些其他功能；</p><blockquote><p>This pointer enables you to have multiple owners of data by keeping track of the number of owners and, when no owners remain, cleaning up the data.</p></blockquote><p>Rust中普通的指针只是一个借用，然而智能指针是拥有</p><blockquote><p>In Rust, which uses the concept of ownership and borrowing, an additional difference between references and smart pointers is that references are pointers that only borrow data; in contrast, in many cases, smart pointers own the data they point to.</p></blockquote><p>指针指针是一种实现了<code>Deref</code>和<code>Drop</code>接口的结构体</p><p><code>box</code>是Rust中常用的智能指针，它会将存储的数据放在堆中而不是栈上。该指针也不会影响性能，只是没有额外的功能罢了。</p><ul><li>When you have a type whose size can’t be known at compile time and you want to use a value of that type in a context that requires an exact size</li><li>When you have a large amount of data and you want to transfer ownership but ensure the data won’t be copied when you do so</li><li>When you want to own a value and you care only that it’s a type that implements a particular trait rather than being of a specific type</li></ul><pre><code class=language-rust>fn main() {
    let b = Box::new(5);
    println!(&quot;b = {}&quot;, b);
}
</code></pre><p>使用<code>Deref</code>来控制解引用的过程</p><pre><code class=language-rust>use std::ops::Deref;

impl&lt;T&gt; Deref for MyBox&lt;T&gt; {
    type Target = T;

    fn deref(&amp;self) -&gt; &amp;T {
        &amp;self.0
    }
}

struct MyBox&lt;T&gt;(T);

impl&lt;T&gt; MyBox&lt;T&gt; {
    fn new(x: T) -&gt; MyBox&lt;T&gt; {
        MyBox(x)
    }
}

fn main() {
    let x = 5;
    let y = MyBox::new(x);

    assert_eq!(5, x);
    assert_eq!(5, *y);
}
</code></pre><p>当一个变量的值将要离开作用域的时候，可以使用<code>Drop</code>特质来提前感知这一操作并做出相应的处理。例如：<em>Box<t></em>就是使用来<code>Drop</code>来释放它所持有的指针的。</p><pre><code class=language-rust>struct CustomSmartPointer {
    data: String,
}

impl Drop for CustomSmartPointer {
    fn drop(&amp;mut self) {
        println!(&quot;Dropping CustomSmartPointer with data `{}`!&quot;, self.data);
    }
}

fn main() {
    let c = CustomSmartPointer {
        data: String::from(&quot;my stuff&quot;),
    };
    let d = CustomSmartPointer {
        data: String::from(&quot;other stuff&quot;),
    };
    println!(&quot;CustomSmartPointers created.&quot;);
}
</code></pre><p><code>Drop</code>特质相当与告诉编译器，在特定的地方自动插入代码使其调用<em>drop</em>方法，好让变量自动释放。</p><p>该特质的<em>drop</em>方法不支持手动调用，该方法必须由编译器来自动调用，如果手动调用该方法会编译不通过的 （<strong>explicit destructor calls not allowed</strong>）。</p><p>原因很简单，Rust并不会智能到见到到了手动调用<em>drop</em>就会不执行已经插入的自动<em>drop</em>方法，所以会造成<em>两次释放同一个变量</em></p><blockquote><p>Rust doesn’t let us call drop explicitly because Rust would still automatically call drop on the value at the end of main. This would be a double free error because Rust would be trying to clean up the same value twice.</p></blockquote><p>当然有些情况我们是想要提前释放资源，这种情况就需要使用标准库中<strong>std::mem::drop</strong>的<em>drop</em>函数</p><pre><code class=language-rust>struct CustomSmartPointer {
    data: String,
}

impl Drop for CustomSmartPointer {
    fn drop(&amp;mut self) {
        println!(&quot;Dropping CustomSmartPointer with data `{}`!&quot;, self.data);
    }
}

fn main() {
    let c = CustomSmartPointer {
        data: String::from(&quot;some data&quot;),
    };
    println!(&quot;CustomSmartPointer created.&quot;);
    drop(c);
    println!(&quot;CustomSmartPointer dropped before the end of main.&quot;);
}
</code></pre><p><code>Rc&lt;T></code>（全称：<em>reference counting</em>）是一个可以让变量拥有多个<em>owner</em>的指针。</p><p>官方举了个例子，生动形象的理解<code>Rc&lt;T></code></p><blockquote><p>Imagine Rc<t> as a TV in a family room. When one person enters to watch TV, they turn it on. Others can come into the room and watch the TV. When the last person leaves the room, they turn off the TV because it’s no longer being used. If someone turns off the TV while others are still watching it, there would be uproar from the remaining TV watchers!</p></blockquote><pre><code class=language-rust>enum List {
    Cons(i32, Rc&lt;List&gt;),
    Nil,
}

use crate::List::{Cons, Nil};
use std::rc::Rc;

fn main() {
    let a = Rc::new(Cons(5, Rc::new(Cons(10, Rc::new(Nil)))));
    let b = Cons(3, Rc::clone(&amp;a));
    let c = Cons(4, Rc::clone(&amp;a));
}
</code></pre><p><code>Rc::clone</code>使用的是浅拷贝，这里每次拷贝了之后会使<em>a</em>引用计数加一。也可以使用<code>a.clone()</code>，如何使用<code>clone</code>取决于使用场景。</p><blockquote><p>We could have called a.clone() rather than Rc::clone(&a), but Rust’s convention is to use Rc::clone in this case. The implementation of Rc::clone doesn’t make a deep copy of all the data like most types’ implementations of clone do. The call to Rc::clone only increments the reference count, which doesn’t take much time. Deep copies of data can take a lot of time. By using Rc::clone for reference counting, we can visually distinguish between the deep-copy kinds of clones and the kinds of clones that increase the reference count. When looking for performance problems in the code, we only need to consider the deep-copy clones and can disregard calls to Rc::clone.</p></blockquote><p>可以使用<code>Rc::strong_count(&a)</code>查看当前变量有多少个引用。</p><p><code>RefCell&lt;T></code> (不知名指针)用于打破Rust规则的指针。因为有时Rust编译器不能正确的分析出代码的<em>Ownership</em>就会拒绝编译，但是编写代码者能够保证这段代码是符合Rust规则的，所以这个时候就可以使用这个指针来使编译通过，并且在<strong>运行时</strong>来进行<em>Ownership</em>的检查工作，如果发现规则被打破，就会<em>panic</em>。</p><blockquote><p>The advantage of checking the borrowing rules at runtime instead is that certain memory-safe scenarios are then allowed, whereas they are disallowed by the compile-time checks. Static analysis, like the Rust compiler, is inherently conservative. Some properties of code are impossible to detect by analyzing the code: the most famous example is the Halting Problem, which is beyond the scope of this book but is an interesting topic to research.</p><p>Because some analysis is impossible, if the Rust compiler can’t be sure the code complies with the ownership rules, it might reject a correct program; in this way, it’s conservative. If Rust accepted an incorrect program, users wouldn’t be able to trust in the guarantees Rust makes. However, if Rust rejects a correct program, the programmer will be inconvenienced, but nothing catastrophic can occur. The RefCell<t> type is useful when you’re sure your code follows the borrowing rules but the compiler is unable to understand and guarantee that.</p></blockquote><p><code>Rc&lt;T>, RefCell&lt;T></code>这两个指针都只能在<strong>单线程</strong>的环境下使用。</p><p><code>Box&lt;T>, Rc&lt;T>, RefCell&lt;T></code>三者的区别</p><ul><li><code>Rc&lt;T></code>允许一个变量有多个拥有者，其他两个只能有一个。</li><li><code>Box&lt;T></code>支持<em>编译期的</em>可变的和不可变的借用检查；<code>Rc&lt;T></code>支持<em>编译期</em>的不可变的借用检查；<code>RefCell&lt;T></code>支持<em>运行时</em>的可变的和不可变的借用检查；</li><li><code>Refcell&lt;T></code>可以改变一个不可变的变量（Because RefCell<t> allows mutable borrows checked at runtime, you can mutate the value inside the RefCell<t> even when the RefCell<t> is immutable.）</li></ul><p>突变模式？！</p><blockquote><p>Mutating the value inside an immutable value is the interior mutability pattern.</p></blockquote><pre><code class=language-rust>#[derive(Debug)]
enum List {
    Cons(Rc&lt;RefCell&lt;i32&gt;&gt;, Rc&lt;List&gt;),
    Nil,
}

use crate::List::{Cons, Nil};
use std::cell::RefCell;
use std::rc::Rc;

fn main() {
    let value = Rc::new(RefCell::new(5));

    let a = Rc::new(Cons(Rc::clone(&amp;value), Rc::new(Nil)));

    let b = Cons(Rc::new(RefCell::new(6)), Rc::clone(&amp;a));
    let c = Cons(Rc::new(RefCell::new(10)), Rc::clone(&amp;a));

    *value.borrow_mut() += 10;

    println!(&quot;a after = {:?}&quot;, a);
    println!(&quot;b after = {:?}&quot;, b);
    println!(&quot;c after = {:?}&quot;, c);
}
</code></pre><p>循环依赖可能会造成内存泄漏的问题，因为使用了<code>Rc&lt;T></code>如果相互依赖那么引用数就永远不会为0。（Java中的GC也有这个问题，用可达性分析解决的）</p><pre><code class=language-rust>use crate::List::{Cons, Nil};
use std::cell::RefCell;
use std::rc::Rc;

#[derive(Debug)]
enum List {
    Cons(i32, RefCell&lt;Rc&lt;List&gt;&gt;),
    Nil,
}

impl List {
    fn tail(&amp;self) -&gt; Option&lt;&amp;RefCell&lt;Rc&lt;List&gt;&gt;&gt; {
        match self {
            Cons(_, item) =&gt; Some(item),
            Nil =&gt; None,
        }
    }
}

fn main() {
    let a = Rc::new(Cons(5, RefCell::new(Rc::new(Nil))));

    println!(&quot;a initial rc count = {}&quot;, Rc::strong_count(&amp;a));
    println!(&quot;a next item = {:?}&quot;, a.tail());

    let b = Rc::new(Cons(10, RefCell::new(Rc::clone(&amp;a))));

    println!(&quot;a rc count after b creation = {}&quot;, Rc::strong_count(&amp;a));
    println!(&quot;b initial rc count = {}&quot;, Rc::strong_count(&amp;b));
    println!(&quot;b next item = {:?}&quot;, b.tail());

    if let Some(link) = a.tail() {
        *link.borrow_mut() = Rc::clone(&amp;b);
    }

    println!(&quot;b rc count after changing a = {}&quot;, Rc::strong_count(&amp;b));
    println!(&quot;a rc count after changing a = {}&quot;, Rc::strong_count(&amp;a));

    // Uncomment the next line to see that we have a cycle;
    // it will overflow the stack
    // println!(&quot;a next item = {:?}&quot;, a.tail());
}
</code></pre><p>Rust无法处理循环依赖导致的内存泄露问题，因为这都是写代码自己的写的问题，换成其他语言也会出现这样的问题。</p><p>但Rust也不是任人自生自灭，如何防止循环引用的形成，Rust中引入了<em>弱引用</em>的概念（Java中的<em>虚引用</em>），使用<code>Rc&lt;T></code>中的<code>Rc::downgrade</code>会增加<code>weak_count</code>的数量，然而回收的时候不管<em>week_count</em>是否是0都会回收释放资源，只要<code>strong_count</code>为0时。</p><p>为了能够从新获取<em>弱引用</em>，可以使用<code>upgrade</code>方法对其进行升级，返回的是一个<code>Option&lt;Rc&lt;T>></code></p><pre><code class=language-rust>use std::cell::RefCell;
use std::rc::{Rc, Weak};

#[derive(Debug)]
struct Node {
    value: i32,
    parent: RefCell&lt;Weak&lt;Node&gt;&gt;,
    children: RefCell&lt;Vec&lt;Rc&lt;Node&gt;&gt;&gt;,
}

fn main() {
    let leaf = Rc::new(Node {
        value: 3,
        parent: RefCell::new(Weak::new()),
        children: RefCell::new(vec![]),
    });

    println!(&quot;leaf parent = {:?}&quot;, leaf.parent.borrow().upgrade());

    let branch = Rc::new(Node {
        value: 5,
        parent: RefCell::new(Weak::new()),
        children: RefCell::new(vec![Rc::clone(&amp;leaf)]),
    });

    *leaf.parent.borrow_mut() = Rc::downgrade(&amp;branch);

    println!(&quot;leaf parent = {:?}&quot;, leaf.parent.borrow().upgrade());
}
</code></pre><p>智能指针，有点复杂...</p><p>完！</p></div><div class=article-footer><blockquote class=mt-2x><ul class="post-copyright list-unstyled"><li class="post-copyright-link hidden-xs"><strong>Permalink:</strong>
<a href=https://holicc.github.io/2020/08/rust-smart-pointer/ title="Rust Smart Pointer" target=_blank rel=external>https://holicc.github.io/2020/08/rust-smart-pointer/</a></li><li class=post-copyright-license><strong>License：</strong><a href=http://creativecommons.org/licenses/by/4.0/deed.zh target=_blank rel=external>CC BY 4.0 CN</a></li></ul></blockquote><div class="panel panel-default panel-badger"><div class=panel-body><figure class=media><div class=media-left><a href=https://github.com/LuLongShan target=_blank class="img-burn thumb-sm visible-lg"><img src=https://holicc.github.io/avatar.png class="img-rounded w-full" alt></a></div><div class=media-body><h3 class=media-heading><a href=https://github.com/LuLongShan target=_blank><span class=text-dark>Joe</span><small class=ml-1x>Hello World</small></a></h3><div>people are resources</div></div></figure></div></div></div></article><section id=comments><div id=disqus_thread><noscript>Please enable JavaScript to view the <a href=//disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript></div></section></div><nav class="bar bar-footer clearfix" data-stick-bottom><div class=bar-inner><ul class="pager pull-left"><li class=prev><a href=https://holicc.github.io/2020/07/rust-testing/ title="Rust Testing"><i class="icon icon-angle-left" aria-hidden=true></i><span>&nbsp;&nbsp;Older</span></a></li><li class=next><a href=https://holicc.github.io/2020/08/powershell-notes/ title="Powershell Notes"><span>Newer&nbsp;&nbsp;</span><i class="icon icon-angle-right" aria-hidden=true></i></a></li><li class=toggle-toc><a class="toggle-btn collapsed" data-toggle=collapse href=#collapseToc aria-expanded=false title=Catalogue role=button><span>[&nbsp;</span><span>Catalogue</span>
<i class="text-collapsed icon icon-anchor"></i><i class="text-in icon icon-close"></i><span>]</span></a></li></ul><div class=bar-right><div class=share-component data-sites=weibo,qq,wechat,facebook,twitter data-mobile-sites=weibo,qq,qzone></div></div></div></nav></main><footer class=footer itemscope itemtype=http://schema.org/WPFooter><ul class=social-links><li><a href=https://github.com/LuLongShan target=_blank title=github data-toggle=tooltip data-placement=top><i class="icon icon-github"></i></a></li><li><a href=https://holicc.github.io/index.xml target=_blank title=rss data-toggle=tooltip data-placement=top><i class="icon icon-rss"></i></a></li></ul><div class=copyright>&copy;2017 -
2020<div class=publishby>Theme by <a href=https://github.com/xiaoheiAh target=_blank>xiaoheiAh </a>base on<a href=https://github.com/xiaoheiAh/hugo-theme-pure target=_blank> pure</a>.</div></div></footer><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.2/MathJax.js?config=TeX-MML-AM_SVG"></script><script type=text/x-mathjax-config>
    MathJax.Hub.Config({
            showMathMenu: false, //disables context menu
            tex2jax: {
            inlineMath: [ ['$','$'], ['\\(','\\)'] ]
           }
    });
</script><script src=https://cdn.jsdelivr.net/npm/jquery@3.4.1/dist/jquery.min.js></script><script>window.jQuery||document.write('<script src="js/jquery.min.js"><\/script>')</script><script type=text/javascript src=https://cdn.staticfile.org/highlight.js/9.15.10/highlight.min.js></script><script type=text/javascript src=https://cdn.staticfile.org/highlight.js/9.15.10/languages/python.min.js defer></script><script type=text/javascript src=https://cdn.staticfile.org/highlight.js/9.15.10/languages/javascript.min.js defer></script><script type=text/javascript src=https://cdn.staticfile.org/highlight.js/9.15.10/languages/java.min.js defer></script><script type=text/javascript src=https://cdn.staticfile.org/highlight.js/9.15.10/languages/go.min.js defer></script><script type=text/javascript src=https://cdn.staticfile.org/highlight.js/9.15.10/languages/sql.min.js defer></script><script type=text/javascript src=https://cdn.staticfile.org/highlight.js/9.15.10/languages/rust.min.js defer></script><script>hljs.configure({tabReplace:'    ',classPrefix:''})
hljs.initHighlightingOnLoad();</script><script src=https://holicc.github.io/js/application.min.bdeb64b910570b6c41badc6a05b7afb0c8ad9efd8525de3c7257d59e786326a3.js></script><script src=https://holicc.github.io/js/plugin.min.51ff8c7317566f82259170fa36e09c4493adc9b9378b427a01ad3f017ebac7dd.js></script><script>(function(window){var INSIGHT_CONFIG={TRANSLATION:{POSTS:'Posts',PAGES:'Pages',CATEGORIES:'Categories',TAGS:'Tags',UNTITLED:'(Untitled)',},ROOT_URL:'https:\/\/holicc.github.io\/',CONTENT_URL:'https:\/\/holicc.github.io\/\/searchindex.json ',};window.INSIGHT_CONFIG=INSIGHT_CONFIG;})(window);</script><script type=text/javascript src=https://holicc.github.io/js/insight.min.a343cd9a5a7698336b28ef3a7c16a3a1b1d2d5fb17dc8ed04022bbe08cc5459073a15bdafa3a8a58cdd56080784bdd69fa70b1ae8597565c799c57ed00f0e120.js defer></script><script src=https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.4.2/tocbot.min.js></script><script>tocbot.init({tocSelector:'.js-toc',contentSelector:'.js-toc-content',headingSelector:'h1, h2, h3',hasInnerContainers:true,});</script><script>var disqus_config=function(){this.page.url='https:\/\/holicc.github.io\/2020\/08\/rust-smart-pointer\/';this.page.identifier='takijoe';};(function(){var d=document,s=d.createElement('script');s.src='//'+'takijoe'+'.disqus.com/embed.js';s.setAttribute('data-timestamp',+new Date());(d.head||d.body).appendChild(s);})();</script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-157580785-1','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script></body></html>